import os
import streamlit as st
from dotenv import load_dotenv
from transformers import AutoTokenizer, AutoModelForQuestionAnswering, pipeline
from langchain_community.vectorstores import FAISS
from langchain_huggingface import HuggingFaceEmbeddings
from langchain_community.document_loaders import DataFrameLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
import pandas as pd
from langfuse import Langfuse 

# Загрузка переменных окружения
load_dotenv()

# Настройка Streamlit
st.title("Медицинская система разработчик Димас Тараканов")

# Поле для ввода запроса пользователем
user_input = st.text_input("Введите ваш запрос:")

# Данные
documents_data = [
    {
        "id": 1,
        "question": "Как записаться на прием к врачу?",
        "answer": """Записаться на прием к врачу можно несколькими способами:
1) Через сайт клиники: выберите врача, дату и время приема, заполните форму записи.
2) По телефону: позвоните в регистратуру клиники и запишитесь на удобное время.
3) Через мобильное приложение клиники: выберите врача и запишитесь на прием.
4) Лично в регистратуре клиники.
Для записи может потребоваться полис ОМС или данные страховки, если вы записываетесь по ДМС.""",
        "url": "clinic/appointment"
    },
    {
        "id": 2,
        "question": "Какие документы нужны для первого визита?",
        "answer": """Для первого визита в клинику необходимо иметь при себе следующие документы:
1) Паспорт или другой документ, удостоверяющий личность.
2) Полис обязательного медицинского страхования (ОМС) или полис добровольного медицинского страхования (ДМС), если лечение по страховке.
3) СНИЛС (при наличии).
4) Медицинскую карту или выписки от предыдущих врачей (если есть).
5) Направление от врача (если требуется).
Если вы записываетесь на платный прием, достаточно паспорта.""",
        "url": "clinic/first-visit-documents"
    },
    {
        "id": 3,
        "question": "Как получить направление на анализы?",
        "answer": """Чтобы получить направление на анализы, выполните следующие шаги:
1) Обратитесь к лечащему врачу на приеме.
2) Врач выпишет направление на необходимые анализы.
3) С направлением обратитесь в лабораторию клиники или в указанное медицинское учреждение.
4) Некоторые анализы требуют специальной подготовки (например, сдача крови натощак), уточните это у врача или в лаборатории.
Направление действительно в течение указанного срока, обычно это 10-14 дней.""",
        "url": "clinic/analysis-referral"
    },
    {
        "id": 4,
        "question": "Как подготовиться к УЗИ?",
        "answer": """Подготовка к УЗИ зависит от типа исследования:
1) УЗИ органов брюшной полости: за 2-3 дня до исследования исключите из рациона продукты, вызывающие газообразование (бобовые, молочные продукты, газированные напитки). В день исследования не ешьте и не пейте за 6-8 часов до процедуры.
2) УЗИ мочевого пузыря: за 1-1.5 часа до исследования выпейте 1-1.5 литра воды и не мочитесь.
3) УЗИ других органов: специальной подготовки не требуется.
Уточните у врача или администратора клиники, если у вас есть сомнения.""",
        "url": "clinic/ultrasound-preparation"
    },
    {
        "id": 5,
        "question": "Как получить результаты анализов?",
        "answer": """Результаты анализов можно получить несколькими способами:
1) В личном кабинете на сайте клиники или в мобильном приложении.
2) По электронной почте, если вы указали ее при сдаче анализов.
3) Лично в регистратуре клиники, предъявив паспорт.
4) По телефону, если вы предоставили согласие на передачу информации таким способом.
Сроки готовности анализов зависят от их типа и могут составлять от нескольких часов до нескольких дней.""",
        "url": "clinic/analysis-results"
    },
    {
        "id": 6,
        "question": "Как оформить больничный лист?",
        "answer": """Для оформления больничного листа выполните следующие шаги:
1) Обратитесь к врачу на приеме и сообщите о необходимости оформить больничный лист.
2) Врач заполнит электронный больничный лист в системе ФСС.
3) Вы получите номер электронного больничного листа, который можно передать работодателю.
4) Если требуется бумажный вариант, сообщите об этом врачу.
Больничный лист оформляется при наличии медицинских показаний и может быть выдан на срок до 15 дней. Продление возможно по решению врачебной комиссии.""",
        "url": "clinic/sick-leave"
    },
    {
        "id": 7,
        "question": "Как получить справку для ГИБДД?",
        "answer": """Для получения медицинской справки для ГИБДД выполните следующие шаги:
1) Запишитесь на прием к терапевту.
2) Пройдите осмотр у терапевта и необходимых специалистов (окулист, психиатр, нарколог).
3) Сдайте необходимые анализы (кровь на сахар, мочу и др.).
4) После прохождения всех специалистов и получения результатов анализов терапевт выдаст медицинскую справку.
Справка для ГИБДД действует в течение 1 года с момента выдачи.""",
        "url": "clinic/gibdd-certificate"
    },
    {
        "id": 8,
        "question": "Как записаться на вакцинацию?",
        "answer": """Записаться на вакцинацию можно следующими способами:
1) Через сайт клиники: выберите вакцину, дату и время, заполните форму записи.
2) По телефону регистратуры клиники.
3) Через портал госуслуг (если вакцинация проводится в рамках государственной программы).
4) Лично в регистратуре клиники.
Для вакцинации может потребоваться паспорт и полис ОМС. Уточните список необходимых документов при записи.""",
        "url": "clinic/vaccination"
    },
    {
        "id": 9,
        "question": "Как получить консультацию специалиста онлайн?",
        "answer": """Для получения онлайн-консультации специалиста выполните следующие шаги:
1) Запишитесь на онлайн-консультацию через сайт клиники или мобильное приложение.
2) Выберите врача и удобное время для консультации.
3) Оплатите консультацию, если она платная.
4) В назначенное время подключитесь к консультации через личный кабинет на сайте или в мобильном приложении.
Для онлайн-консультации может потребоваться веб-камера, микрофон и стабильное интернет-соединение.""",
        "url": "clinic/online-consultation"
    },
    {
        " id": 10,
        "question": "Как оплатить услуги клиники?",
        "answer": """Оплатить услуги клиники можно несколькими способами:
1) Наличными или банковской картой в кассе клиники.
2) Банковской картой через терминал самообслуживания в клинике.
3) Онлайн через личный кабинет на сайте клиники или в мобильном приложении.
4) Банковским переводом по реквизитам клиники.
При оплате онлайн или банковским переводом сохраняйте квитанцию об оплате и сообщайте об этом администратору клиники.""",
        "url": "clinic/payment"
    },
    {
        "id": 11,
        "question": "Как отменить или перенести запись на прием?",
        "answer": """Чтобы отменить или перенести запись на прием, выполните следующие шаги:
1) Через личный кабинет на сайте клиники или в мобильном приложении: найдите вашу запись и выберите опцию «Отменить» или «Перенести».
2) По телефону: позвоните в регистратуру клиники и сообщите об отмене или переносе записи.
3) Лично в регистратуре клиники.
Отмену или перенос записи рекомендуется делать не менее чем за 24 часа до назначенного времени, чтобы избежать штрафных санкций.""",
        "url": "clinic/cancel-reschedule"
    },
    {
        "id": 12,
        "question": "Какие виды страховок принимает клиника?",
        "answer": """Наша клиника работает с следующими видами страховок:
1) Обязательное медицинское страхование (ОМС).
2) Добровольное медицинское страхование (ДМС) от различных страховых компаний, таких как СОГАЗ, Ингосстрах, АльфаСтрахование и другие.
3) Корпоративные программы медицинского страхования.
Перед визитом уточните у администратора клиники, работает ли ваша страховая компания с нашей клиникой, и какие услуги покрываются вашей страховкой.""",
        "url": "clinic/insurance"
    },
    {
        "id": 13,
        "question": "Как получить выписку из медицинской карты?",
        "answer": """Для получения выписки из медицинской карты выполните следующие шаги:
1) Обратитесь в регистратуру клиники с паспортом.
2) Напишите заявление на получение выписки из медицинской карты.
3) Укажите, для каких целей вам необходима выписка (например, для предъявления в другую клинику, для страховой компании и т.д.).
4) Оплатите услугу, если она платная.
5) Получите выписку в регистратуре или через личный кабинет на сайте клиники.
Выписка будет готова в течение 1-3 рабочих дней.""",
        "url": "clinic/medical-record-extract"
    },
    {
        "id": 14,
        "question": "Как пройти диспансеризацию?",
        "answer": """Для прохождения диспансеризации выполните следующие шаги:
1) Запишитесь на диспансеризацию через сайт клиники, по телефону или лично в регистратуре.
2) Пройдите первый этап диспансеризации, который включает осмотр терапевта, общий и биохимический анализы крови, общий анализ мочи, ЭКГ и другие исследования.
3) По результатам первого этапа терапевт назначит дополнительные обследования, если они необходимы.
4) Пройдите второй этап диспансеризации, который может включать консультации узких специалистов и дополнительные обследования.
5) Получите заключение терапевта по результатам диспансеризации.
Диспансеризация проводится бесплатно в рамках программы ОМС и включает широкий спектр обследований.""",
        "url": "clinic/dispensary-examination"
    },
    {
        "id": 15,
        "question": "Как записаться на МРТ?",
        "answer": """Для записи на МРТ выполните следующие шаги:
1) Получите направление от лечащего врача (если требуется).
2) Запишитесь на процедуру через сайт клиники, по телефону или лично в регистратуре.
3) Уточните у администратора, требуется ли специальная подготовка к исследованию.
4) В назначенное время придите в клинику с направлением (если есть) и необходимыми документами (паспорт, полис ОМС или ДМС).
5) Пройдите процедуру МРТ.
Результаты исследования обычно готовы в течение 1-3 дней и могут быть получены в личном кабинете или в регистратуре клиники.""",
        "url": "clinic/mri-appointment"
    }
]


# Создание DataFrame
df = pd.DataFrame(documents_data)

# Загрузка данных в LangChain
loader = DataFrameLoader(df, page_content_column='question')
documents = loader.load()

# Разделение текста на части
text_splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=0)
texts = text_splitter.split_documents(documents)

# Векторизация с использованием HuggingFaceEmbeddings
embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2")

# Создание хранилища FAISS
db = FAISS.from_documents(texts, embeddings)

# Загрузка модели и токенайзера
model_name = "Den4ikAI/rubert_large_squad_2"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForQuestionAnswering.from_pretrained(model_name)

# Создание пайплайна для вопросно-ответной системы
qa_pipeline = pipeline(
    "question-answering",
    model=model,
    tokenizer=tokenizer,
    device=-1  # Используем CPU
)

if user_input:
    try:
        # Получение релевантных документов
        retriever = db.as_retriever()
        docs = retriever.invoke(user_input)

        # Формирование контекста
        context = "\n".join([doc.page_content + "\n" + doc.metadata['answer'] for doc in docs])

        # Задаем вопрос и контекст в нужном формате
        question_answering_input = {
            "question": user_input,
            "context": context
        }

        # Получение ответа от модели
        response = qa_pipeline(question_answering_input)

        # Отображаем ответ модели
        st.write("Ответ модели:")
        st.write(response['answer'])
    except Exception as e:
        st.error(f"Произошла ошибка: {e}")
